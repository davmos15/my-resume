<h1 class="page-title">Projects</h1>

<div class="card">
    <div style="margin-bottom: 20px;">
        <a href="/admin/projects/new" class="btn btn-success">+ Add New Project</a>
    </div>

    <div class="sortable-table">
        <table class="table">
            <thead>
                <tr>
                    <th width="30px">⋮⋮</th>
                    <th>Title</th>
                    <th>Technologies</th>
                    <th>Status</th>
                    <th>Order</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="sortable-projects">
                <% if (projects && projects.length > 0) { %>
                    <% projects.forEach(project => { %>
                        <tr data-id="<%= project.id %>" class="sortable-row">
                            <td class="drag-handle" style="cursor: move;">⋮⋮</td>
                            <td><%= project.title %></td>
                            <td><%= project.technologies || 'N/A' %></td>
                            <td>
                                <span style="color: <%= project.is_active ? '#27ae60' : '#e74c3c' %>">
                                    <%= project.is_active ? 'Active' : 'Inactive' %>
                                </span>
                            </td>
                            <td><%= project.display_order %></td>
                            <td>
                                <div class="actions">
                                    <a href="/admin/projects/edit/<%= project.id %>" class="btn btn-primary btn-sm">Edit</a>
                                    <a href="/admin/projects/delete/<%= project.id %>" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this project?')">Delete</a>
                                </div>
                            </td>
                        </tr>
                    <% }); %>
                <% } else { %>
                    <tr>
                        <td colspan="6" style="text-align: center;">No projects found</td>
                    </tr>
                <% } %>
            </tbody>
        </table>
    </div>
</div>

<style>
.sortable-row {
    cursor: move;
}

.sortable-row:hover {
    background-color: #f8f9fa;
}

.drag-handle {
    color: #999;
    user-select: none;
}

.sortable-ghost {
    opacity: 0.4;
}

.sortable-chosen {
    background-color: #e3f2fd !important;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const element = document.getElementById('sortable-projects');
    if (element) {
        new Sortable(element, {
            handle: '.drag-handle',
            animation: 150,
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            onEnd: function(evt) {
                updateOrder(evt.to);
            }
        });
    }
});

async function updateOrder(container) {
    const rows = container.querySelectorAll('tr[data-id]');
    const updates = Array.from(rows).map((row, index) => ({
        id: row.dataset.id,
        display_order: index
    }));

    try {
        const response = await fetch('/admin/projects/reorder', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ updates })
        });

        if (!response.ok) {
            throw new Error('Failed to update order');
        }

        // Update the display order in the UI
        rows.forEach((row, index) => {
            const orderCell = row.querySelector('td:nth-child(5)');
            if (orderCell) {
                orderCell.textContent = index;
            }
        });

    } catch (error) {
        console.error('Error updating order:', error);
        alert('Failed to update order. Please refresh the page.');
    }
}
</script>