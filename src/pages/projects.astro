---
import BaseLayout from '../layouts/BaseLayout.astro';
import CardModal from '../components/CardModal.astro';
import db from '../lib/db.js';

// Fetch projects
let projects = [];
try {
  const stmt = db.prepare('SELECT * FROM projects WHERE is_active = 1 ORDER BY display_order, id DESC');
  projects = stmt.all();
} catch (err) {
  console.error('Error fetching projects:', err);
}
---

<BaseLayout title="Projects - Nadav Moskow">
  <link rel="stylesheet" href="/css/unified-cards.css">
  
  <div id="projects-page">
    <div class="page-header">
      <h1>My Projects</h1>
      <p class="page-subtitle">Click on any project to explore in detail</p>
    </div>
    
    <div class="card-grid">
      {projects.map((project) => (
        <div class="card-item" data-card-type="project" data-card-id={project.id}>
          <div class="card-inner">
            <span class="card-emoji">{project.emoji || 'üöÄ'}</span>
            <h3 class="card-title">{project.title}</h3>
            {project.subtitle && <p class="card-subtitle">{project.subtitle}</p>}
          </div>
          <div class="card-hover-overlay">
            <span class="hover-text">View Project ‚Üí</span>
          </div>
        </div>
      ))}
    </div>
  </div>
  
  <CardModal />
  
  <script define:vars={{ projects }}>
    function buildProjectContent(project) {
      // Build the modal content
      let content = `
        <div class="modal-section">
          <h3>Overview</h3>
          <p>${project.description || 'No description available'}</p>
        </div>
      `;
      
      if (project.technologies) {
        content += `
          <div class="modal-section">
            <h3>Technologies</h3>
            <div class="tech-tags">
              ${project.technologies.split(',').map(tech => 
                `<span class="tech-tag">${tech.trim()}</span>`
              ).join('')}
            </div>
          </div>
        `;
      }
      
      if (project.github_link || project.live_link) {
        content += `
          <div class="modal-section">
            <div class="project-links">
              ${project.github_link ? `<a href="${project.github_link}" target="_blank" class="project-link">GitHub</a>` : ''}
              ${project.live_link ? `<a href="${project.live_link}" target="_blank" class="project-link">Live Demo</a>` : ''}
            </div>
          </div>
        `;
      }
      
      return content;
    }
    
    // Simple polling function to set up cards when modal is ready
    function trySetupCards() {
      console.log('üöÄ Projects: Attempting to setup cards...');
      
      // Check if safeOpenModal is available (indicates modal system is ready)
      if (!window.safeOpenModal) {
        console.log('‚è≥ Projects: Safe modal function not ready yet');
        return false;
      }
      
      // Ensure modal manager is initialized with fresh DOM references
      if (window.ensureModalManager && !window.ensureModalManager()) {
        console.log('‚è≥ Projects: Modal manager not ready yet');
        return false;
      }
      
      // Set up card click handlers
      const cards = document.querySelectorAll('[data-card-type="project"]');
      console.log('üöÄ Projects: Found', cards.length, 'project cards');
      
      cards.forEach((card, index) => {
        console.log('üöÄ Projects: Setting up card', index + 1, 'id:', card.getAttribute('data-card-id'));
        card.onclick = function() {
          console.log('üñ±Ô∏è Projects: Card clicked!', this.getAttribute('data-card-id'));
          const projectId = this.getAttribute('data-card-id');
          const project = projects.find(p => p.id == projectId);
          
          if (project) {
            console.log('üîß Projects: Opening modal for project:', project.title);
            if (window.safeOpenModal) {
              window.safeOpenModal({
                icon: project.emoji || 'üöÄ',
                title: project.title,
                subtitle: project.subtitle,
                content: buildProjectContent(project)
              });
            } else {
              console.error('‚ùå Projects: safeOpenModal function not available');
            }
          } else {
            console.error('‚ùå Projects: No project found for ID:', projectId);
          }
        };
      });
      
      console.log('‚úÖ Projects: Card setup complete!');
      return true;
    }
    
    // Simple polling approach - try every 100ms until success
    let attempts = 0;
    const maxAttempts = 50; // 5 seconds max
    
    function pollForModal() {
      console.log('üîÑ Projects: Polling attempt', attempts + 1, 'of', maxAttempts);
      
      if (trySetupCards()) {
        console.log('üéâ Projects: Cards setup successful!');
        return;
      }
      
      if (attempts >= maxAttempts) {
        console.error('‚ùå Projects: Failed to setup cards after', maxAttempts, 'attempts');
        return;
      }
      
      attempts++;
      setTimeout(pollForModal, 100);
    }
    
    // Start polling immediately
    console.log('üöÄ Projects: Starting card setup polling...');
    pollForModal();
  </script>
  
  <style>
    #projects-page {
      padding: 80px 20px 40px;
      min-height: calc(100vh - 120px);
    }
    
    .page-header {
      text-align: center;
      margin-bottom: 40px;
    }
    
    .page-header h1 {
      font-size: 3em;
      margin-bottom: 10px;
    }
    
    .page-subtitle {
      font-size: 1.2em;
      opacity: 0.8;
    }
    
    .modal-section {
      margin-bottom: 30px;
    }
    
    .modal-section h3 {
      margin-bottom: 15px;
      color: var(--text-primary);
    }
    
    .tech-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .tech-tag {
      background: var(--link-color);
      color: white;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 0.9em;
    }
    
    .project-links {
      display: flex;
      gap: 15px;
    }
    
    .project-link {
      display: inline-block;
      padding: 10px 24px;
      background: var(--link-color);
      color: white;
      text-decoration: none;
      border-radius: 8px;
      transition: all 0.2s ease;
    }
    
    .project-link:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
  </style>
</BaseLayout>